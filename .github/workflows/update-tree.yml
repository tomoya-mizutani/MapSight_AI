name: Update directory tree

permissions:
  contents: write   # ãƒªãƒã‚¸ãƒˆãƒªã®èª­ã¿æ›¸ãã‚’è¨±å¯

on:
  push:
    paths:
      - '**'
  workflow_dispatch:

jobs:
  gen-tree:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Generate directory tree (hide .git contents)
        run: |
          start_marker() {
            echo '<!-- DIR-START -->'
            echo '<details>'
            echo '<summary>ğŸ“‚ ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹é€ å›³ (ã‚¯ãƒªãƒƒã‚¯ã§å±•é–‹)</summary>'
            echo
            echo '``` text'
          }

          write_tree() {
            # ãƒ«ãƒ¼ãƒˆã‚’è¡¨ã™ãƒ‰ãƒƒãƒˆ
            echo '.'
            # .git ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã ã‘ã‚’æ˜ç¤ºçš„ã«è¿½åŠ 
            echo 'â”œâ”€â”€ .git'
            # ãã‚Œä»¥å¤–ã‚’ãƒ•ãƒ«éšå±¤è¡¨ç¤º
            #   -I '.git' ã§ .git è‡ªä½“ã¨ãã®ä¸­èº«ã‚’ç„¡è¦–
            #   --dirsfirst: ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’å…ˆã«ã€--prune: ç©ºãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã¯çœç•¥
            tree --charset ascii -a --dirsfirst --prune -I '.git' .
          }

          end_marker() {
            echo '```'
            echo '</details>'
            echo '<!-- DIR-END -->'
          }

          {
            start_marker
            write_tree
            end_marker
          } > TREE.md

      - name: Inject tree into README
        run: |
          # ã¾ãšæ—¢å­˜ã®ãƒãƒ¼ã‚«ãƒ¼è¡Œã‚’ã™ã¹ã¦å‰Šé™¤
          sed -e '/<!-- DIR-START -->/,/<!-- DIR-END -->/d' README.md \
            > README.tmp.md
          # å‰Šé™¤å¾Œã®ãƒ•ã‚¡ã‚¤ãƒ«ã« TREE.md ã®ä¸­èº«ã‚’ã€è¦‹å‡ºã—è¡Œã®ç›´å¾Œã«æŒ¿å…¥
          sed '/## ğŸ“‚ ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹é€ å›³/r TREE.md' README.tmp.md \
            > README.new.md
          mv README.new.md README.md
          rm README.tmp.md TREE.md

      - name: Commit & Push if changed
        uses: stefanzweifel/git-auto-commit-action@v4
        with:
          commit_message: chore:update directory tree
          file_pattern: README.md
